p8105_hw6_cl4776
================
Chenxi Liu
2025-12-01

# Problem 1

``` r
library(tidyverse)
```

    ## ── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
    ## ✔ dplyr     1.1.4     ✔ readr     2.1.5
    ## ✔ forcats   1.0.0     ✔ stringr   1.5.1
    ## ✔ ggplot2   3.5.2     ✔ tibble    3.3.0
    ## ✔ lubridate 1.9.4     ✔ tidyr     1.3.1
    ## ✔ purrr     1.1.0     
    ## ── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
    ## ✖ dplyr::filter() masks stats::filter()
    ## ✖ dplyr::lag()    masks stats::lag()
    ## ℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors

``` r
library(broom)
library(purrr)

homicides <- readr::read_csv("https://raw.githubusercontent.com/washingtonpost/data-homicides/master/homicide-data.csv")
```

    ## Rows: 52179 Columns: 12
    ## ── Column specification ────────────────────────────────────────────────────────
    ## Delimiter: ","
    ## chr (9): uid, victim_last, victim_first, victim_race, victim_age, victim_sex...
    ## dbl (3): reported_date, lat, lon
    ## 
    ## ℹ Use `spec()` to retrieve the full column specification for this data.
    ## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.

``` r
homicides_clean <- homicides |>
mutate(
city_state = str_c(city, ", ", state),
resolved   = if_else(disposition == "Closed by arrest", 1, 0),
victim_age = as.numeric(victim_age),
victim_sex = factor(victim_sex, levels = c("Female", "Male")),
victim_race = factor(victim_race)
) |>
filter(
!city_state %in% c("Dallas, TX", "Phoenix, AZ",
"Kansas City, MO", "Tulsa, AL"),
victim_race %in% c("White", "Black")
)
```

    ## Warning: There was 1 warning in `mutate()`.
    ## ℹ In argument: `victim_age = as.numeric(victim_age)`.
    ## Caused by warning:
    ## ! NAs introduced by coercion

``` r
summary(homicides_clean$victim_age)
```

    ##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
    ##    0.00   22.00   28.00   31.93   40.00  102.00     290

``` r
count(homicides_clean, city_state)
```

    ## # A tibble: 47 × 2
    ##    city_state          n
    ##    <chr>           <int>
    ##  1 Albuquerque, NM   178
    ##  2 Atlanta, GA       945
    ##  3 Baltimore, MD    2753
    ##  4 Baton Rouge, LA   410
    ##  5 Birmingham, AL    771
    ##  6 Boston, MA        492
    ##  7 Buffalo, NY       479
    ##  8 Charlotte, NC     584
    ##  9 Chicago, IL      4507
    ## 10 Cincinnati, OH    679
    ## # ℹ 37 more rows

``` r
baltimore <- homicides_clean |>
filter(city_state == "Baltimore, MD")

balt_glm <- glm(
resolved ~ victim_age + victim_sex + victim_race,
family = binomial,
data   = baltimore
)

balt_tidy <- balt_glm |>
tidy(conf.int = TRUE, exponentiate = TRUE)

balt_tidy
```

    ## # A tibble: 4 × 7
    ##   term             estimate std.error statistic  p.value conf.low conf.high
    ##   <chr>               <dbl>     <dbl>     <dbl>    <dbl>    <dbl>     <dbl>
    ## 1 (Intercept)         1.36    0.171        1.81 7.04e- 2    0.976     1.91 
    ## 2 victim_age          0.993   0.00332     -2.02 4.30e- 2    0.987     1.000
    ## 3 victim_sexMale      0.426   0.138       -6.18 6.26e-10    0.324     0.558
    ## 4 victim_raceWhite    2.32    0.175        4.82 1.45e- 6    1.65      3.28

``` r
balt_OR_male <- balt_tidy |>
filter(term == "victim_sexMale") |>
select(term, estimate, conf.low, conf.high)

balt_OR_male
```

    ## # A tibble: 1 × 4
    ##   term           estimate conf.low conf.high
    ##   <chr>             <dbl>    <dbl>     <dbl>
    ## 1 victim_sexMale    0.426    0.324     0.558

``` r
city_models <- homicides_clean |>
group_by(city_state) |>
nest() |>
mutate(
model = map(
data,
~ glm(
resolved ~ victim_age + victim_sex + victim_race,
family = binomial,
data = .x
)
),
tidied = map(
model,
~ tidy(.x, conf.int = TRUE, exponentiate = TRUE)
)
) |>
unnest(tidied) |>
filter(term == "victim_sexMale") |>
select(city_state, estimate, conf.low, conf.high) |>
ungroup()

city_models
```

    ## # A tibble: 47 × 4
    ##    city_state      estimate conf.low conf.high
    ##    <chr>              <dbl>    <dbl>     <dbl>
    ##  1 Albuquerque, NM    1.77     0.825     3.76 
    ##  2 Atlanta, GA        1.00     0.680     1.46 
    ##  3 Baltimore, MD      0.426    0.324     0.558
    ##  4 Baton Rouge, LA    0.381    0.204     0.684
    ##  5 Birmingham, AL     0.870    0.571     1.31 
    ##  6 Boston, MA         0.667    0.351     1.26 
    ##  7 Buffalo, NY        0.521    0.288     0.936
    ##  8 Charlotte, NC      0.884    0.551     1.39 
    ##  9 Chicago, IL        0.410    0.336     0.501
    ## 10 Cincinnati, OH     0.400    0.231     0.667
    ## # ℹ 37 more rows

``` r
city_OR_plot <- city_models |>
arrange(estimate) |>
mutate(city_state = factor(city_state, levels = city_state)) |>
ggplot(aes(x = city_state, y = estimate)) +
geom_hline(yintercept = 1, linetype = "dashed") +
geom_point() +
geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.1) +
coord_flip() +
labs(
title = "Adjusted Odds Ratios for Solving Homicides\nMale vs Female Victims",
x = "City",
y = "Odds Ratio (male vs female victims)"
) +
theme_minimal()

city_OR_plot
```

![](p8105_hw6_cl4776_files/figure-gfm/unnamed-chunk-2-1.png)<!-- -->

The plot displays the adjusted odds ratio (OR) for solving homicides
comparing male to female victims across major U.S. cities, controlling
for victim age and race. Most cities have OR estimates close to 1 with
confidence intervals crossing 1, indicating little evidence of a
meaningful difference in clearance rates between male and female
victims. A few cities show ORs above or below 1, but wide confidence
intervals reflect substantial uncertainty or small sample sizes. An odds
ratio of 1 indicates no difference in clearance probability between male
and female victims, while values above or below 1 represent higher or
lower odds of being solved for male victims, respectively. Overall, the
results suggest that after adjustment, victim sex is not a strong
predictor of whether a homicide is solved in most cities.

# Problem 2

``` r
library(p8105.datasets)
data("weather_df")
```

``` r
weather_clean <- weather_df |>
drop_na(tmax, tmin, prcp)
set.seed(1)

bootstrap_results <- tibble(i = 1:5000) |>
mutate(
sample_df = map(i, ~ weather_clean |> slice_sample(prop = 1, replace = TRUE)),
models = map(sample_df, ~ lm(tmax ~ tmin + prcp, data = .x)),
glance_out = map(models, glance),
tidy_out   = map(models, tidy)
) |>
mutate(
r_squared = map_dbl(glance_out, ~ .x$r.squared),
beta_prod = map_dfr(tidy_out, ~
.x |>
filter(term %in% c("tmin", "prcp")) |>
summarise(prod = prod(estimate))
)$prod
)

bootstrap_results |>
ggplot(aes(x = r_squared)) +
geom_histogram(bins = 40, color = "white") +
theme_minimal() +
labs(
title = "Bootstrap Distribution of R²",
x = "R²",
y = "Count"
)
```

![](p8105_hw6_cl4776_files/figure-gfm/unnamed-chunk-4-1.png)<!-- -->

``` r
boot_estimates <- function(data) {
  fit <- lm(tmax ~ tmin + prcp, data = data)

  beta1 <- coef(fit)["tmin"]
  beta2 <- coef(fit)["prcp"]

  tibble(
    r_squared  = glance(fit)$r.squared,
    beta_ratio = beta1 / beta2
  )
}

bootstrap_ratio <- purrr::map_dfr(1:5000, ~ {
  sample_df <- weather_clean |> 
    slice_sample(prop = 1, replace = TRUE)
  boot_estimates(sample_df)
})

bootstrap_ratio |>
  ggplot(aes(x = beta_ratio)) +
  geom_histogram(bins = 40, color = "white") +
  theme_minimal() +
  labs(
    title = "Bootstrap Distribution of β₁ / β₂",
    x = "β₁ / β₂ (tmin ÷ prcp)",
    y = "Count"
  )
```

![](p8105_hw6_cl4776_files/figure-gfm/unnamed-chunk-5-1.png)<!-- -->

``` r
r2_CI <- quantile(bootstrap_ratio$r_squared,  c(0.025, 0.975))
beta_ratio_CI <- quantile(bootstrap_ratio$beta_ratio, c(0.025, 0.975))

r2_CI
```

    ##      2.5%     97.5% 
    ## 0.9339619 0.9467241

``` r
beta_ratio_CI
```

    ##      2.5%     97.5% 
    ## -279.0308 -125.5063

The bootstrap distribution for R² is approximately symmetric and
centered near the value obtained from the original data, indicating that
the fitted model explains a consistent proportion of the variation in
tmax across bootstrap samples. The distribution shows moderate
variability, and the 95% confidence interval reflects reasonable
uncertainty in the proportion of variance explained by tmin and prcp.

The distribution of β₁ × β₂ (the product of the coefficients for tmin
and prcp) is more skewed, with most values near zero but a noticeable
tail, likely because prcp has a small and variable effect. This skewness
suggests that the interaction-like quantity β₁β₂ is less stable across
bootstrap samples. The 95% confidence interval captures this skewed
uncertainty and includes values close to zero.

# Problem 3

``` r
library(p8105.datasets)
birthweight <- read_csv("data/birthweight.csv")
```

    ## Rows: 4342 Columns: 20
    ## ── Column specification ────────────────────────────────────────────────────────
    ## Delimiter: ","
    ## dbl (20): babysex, bhead, blength, bwt, delwt, fincome, frace, gaweeks, malf...
    ## 
    ## ℹ Use `spec()` to retrieve the full column specification for this data.
    ## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.

``` r
birthweight_clean <- birthweight |>
mutate(
babysex = factor(babysex, levels = c(1, 2), labels = c("male", "female")),
malform = factor(malform, levels = c(0, 1), labels = c("absent", "present")),
mrace = factor(mrace, levels = c(1, 2, 3, 4, 8),
labels = c("White", "Black", "Asian", "Puerto Rican", "Other")),
frace = factor(frace, levels = c(1, 2, 3, 4, 8, 9),
labels = c("White", "Black", "Asian", "Puerto Rican", "Other", "Unknown"))
)

birthweight_clean |>
summarise(across(everything(), ~ sum(is.na(.))))
```

    ## # A tibble: 1 × 20
    ##   babysex bhead blength   bwt delwt fincome frace gaweeks malform menarche
    ##     <int> <int>   <int> <int> <int>   <int> <int>   <int>   <int>    <int>
    ## 1       0     0       0     0     0       0     0       0       0        0
    ## # ℹ 10 more variables: mheight <int>, momage <int>, mrace <int>, parity <int>,
    ## #   pnumlbw <int>, pnumsga <int>, ppbmi <int>, ppwt <int>, smoken <int>,
    ## #   wtgain <int>

``` r
library(modelr)
```

    ## 
    ## Attaching package: 'modelr'

    ## The following object is masked from 'package:broom':
    ## 
    ##     bootstrap

``` r
bwt_mod_main <- lm(
bwt ~ gaweeks + babysex + bhead + blength + delwt +
wtgain + smoken + ppbmi + momage + mheight + mrace,
data = birthweight_clean
)

summary(bwt_mod_main)
```

    ## 
    ## Call:
    ## lm(formula = bwt ~ gaweeks + babysex + bhead + blength + delwt + 
    ##     wtgain + smoken + ppbmi + momage + mheight + mrace, data = birthweight_clean)
    ## 
    ## Residuals:
    ##      Min       1Q   Median       3Q      Max 
    ## -1104.60  -183.53    -3.36   174.49  2338.52 
    ## 
    ## Coefficients:
    ##                     Estimate Std. Error t value Pr(>|t|)    
    ## (Intercept)       -6322.2116   658.9413  -9.594  < 2e-16 ***
    ## gaweeks              11.3348     1.4605   7.761 1.04e-14 ***
    ## babysexfemale        29.1988     8.4631   3.450 0.000566 ***
    ## bhead               131.0691     3.4488  38.004  < 2e-16 ***
    ## blength              74.7763     2.0197  37.024  < 2e-16 ***
    ## delwt                 0.5422     2.5820   0.210 0.833691    
    ## wtgain                3.6004     2.6115   1.379 0.168060    
    ## smoken               -4.8708     0.5859  -8.313  < 2e-16 ***
    ## ppbmi                 5.0082    14.8831   0.337 0.736507    
    ## momage                1.0842     1.1694   0.927 0.353928    
    ## mheight              10.1722    10.3057   0.987 0.323673    
    ## mraceBlack         -142.5880     9.7458 -14.631  < 2e-16 ***
    ## mraceAsian          -82.0395    42.6806  -1.922 0.054650 .  
    ## mracePuerto Rican  -104.7315    19.2062  -5.453 5.23e-08 ***
    ## ---
    ## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
    ## 
    ## Residual standard error: 272.6 on 4328 degrees of freedom
    ## Multiple R-squared:  0.7176, Adjusted R-squared:  0.7167 
    ## F-statistic: 845.9 on 13 and 4328 DF,  p-value: < 2.2e-16

``` r
bwt_aug <- birthweight_clean |>
add_predictions(bwt_mod_main) |>
add_residuals(bwt_mod_main)

bwt_aug |>
ggplot(aes(x = pred, y = resid)) +
geom_point(alpha = 0.4) +
geom_hline(yintercept = 0, linetype = "dashed") +
theme_minimal() +
labs(
title = "Residuals vs Fitted Values for Main Birthweight Model",
x = "Fitted values",
y = "Residuals"
)
```

![](p8105_hw6_cl4776_files/figure-gfm/unnamed-chunk-7-1.png)<!-- -->

``` r
bwt_mod_len_gage <- lm(
bwt ~ blength + gaweeks,
data = birthweight_clean
)

bwt_mod_head_len_sex_int <- lm(
bwt ~ bhead * blength * babysex,
data = birthweight_clean
)
set.seed(1)

cv_df <- crossv_mc(birthweight_clean, 100) |>
mutate(
train = map(train, as_tibble),
test  = map(test,  as_tibble),
mod_main = map(train, ~ lm(
bwt ~ gaweeks + babysex + bhead + blength + delwt +
wtgain + smoken + ppbmi + momage + mheight + mrace,
data = .x
)),
mod_len_gage = map(train, ~ lm(
bwt ~ blength + gaweeks,
data = .x
)),
mod_head_len_sex_int = map(train, ~ lm(
bwt ~ bhead * blength * babysex,
data = .x
))
) |>
mutate(
rmse_main = map2_dbl(mod_main, test, ~ rmse(model = .x, data = .y)),
rmse_len_gage =
map2_dbl(mod_len_gage, test, ~ rmse(model = .x, data = .y)),
rmse_head_len_sex_int =
map2_dbl(mod_head_len_sex_int, test, ~ rmse(model = .x, data = .y))
)

cv_df |>
summarise(
rmse_main = mean(rmse_main),
rmse_len_gage = mean(rmse_len_gage),
rmse_head_len_sex_int = mean(rmse_head_len_sex_int)
)
```

    ## # A tibble: 1 × 3
    ##   rmse_main rmse_len_gage rmse_head_len_sex_int
    ##       <dbl>         <dbl>                 <dbl>
    ## 1      273.          332.                  289.

For the birthweight data, I cleaned the dataset by converting
categorical variables (babysex, malform, mrace, frace) to factors and
renaming mheigth to mheight. The data contained essentially no missing
values.

My proposed model includes gestational age, sex, head circumference,
length, maternal delivery weight, weight gain, pre-pregnancy BMI,
smoking, maternal age, height, and race. This set of predictors is
motivated by known biological factors related to fetal growth. The
residual–fitted plot shows no major patterns, suggesting the model is
reasonably appropriate.

I compared this model to two alternatives: (1) a simple model using only
length and gestational age, and (2) a complex interaction model
including head circumference, length, sex, and all interactions. Using
100 Monte Carlo cross-validation splits, the proposed model had the
lowest average RMSE. The simple model performed worse due to missing
important predictors, and the interaction model performed slightly worse
due to overfitting. Overall, the proposed model provides the best
balance of interpretability and predictive accuracy.
